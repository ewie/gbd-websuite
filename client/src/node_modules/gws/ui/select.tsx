import * as React from 'react';

import {UiComponent, UiState, UiProps} from './base';
import {Button} from './buttons';
import * as tools from '../tools';

export interface MenuItem {
    text: string;
    value: any;
}

export interface SelectProps extends UiProps {
    value: string;
    items: Array<MenuItem>;
    tooltip?: string;
    placeholder?: string;
    label?: string;
    whenChanged?: any;
    withSearch?: boolean;
    withClear?: boolean;
    up?: boolean;
}

export interface ColorSelectProps extends UiProps {
    value: string;
    items: Array<string>;
    tooltip?: string;
    placeholder?: string;
    label?: string;
    whenChanged?: any;
    withClear?: boolean;
    up?: boolean;
}

export interface MenuProps extends UiProps {
    value: string;
    items: Array<MenuItem>;
    whenSelected: any;
}

export interface ColorMenuProps extends UiProps {
    value: string;
    items: Array<string>;
    whenSelected: any;
}

interface SelectState extends UiState {
    isOpen: boolean;
    searchValue: string;
}

class Menu extends React.PureComponent<MenuProps> {
    render() {
        return <div className='uiMenu'>
            <div className='uiMenuBox'>
                {this.props.items.map(p =>
                    <div
                        className='uiMenuItem'
                        key={p.value}
                        onClick={e => this.props.whenSelected(p.value)}
                    >{p.text}
                    </div>
                )}
            </div>
        </div>
    }
}

class ColorMenu extends React.PureComponent<ColorMenuProps> {
    render() {
        return <div className='uiMenu'>
            <div className='uiMenuBox'>
                {this.props.items.map(p =>
                    <div
                        className='uiColorMenuItem'
                        style={{backgroundColor: p}}
                        key={p}
                        onClick={e => this.props.whenSelected(p)}
                    />
                )}
            </div>
        </div>
    }
}

export class Select extends UiComponent<SelectProps, SelectState> {

    inputRef: React.RefObject<any>;
    rootRef: React.RefObject<HTMLDivElement>;

    constructor(props) {
        super(props);
        this.inputRef = React.createRef();
        this.rootRef = React.createRef();
        this.state = {isOpen: false, searchValue: ''} as SelectState;
    }

    render() {
        let props = {
            className: 'uiRawInput',
            tabIndex: 0,
            ref: this.inputRef,
            title: this.props.tooltip || '',
            placeholder: this.props.placeholder || '',
            onClick: e => this.onClick(e),
            ...this.focusEvents()
        };

        let elem;
        let currentValue = this.textFor(this.props.value);

        if (this.props.withSearch) {
            elem = <input
                {...props}
                value={this.state.hasFocus ? this.state.searchValue : currentValue}
                onKeyDown={e => this.onKeyDown(e)}
                onChange={e => this.onChange(e)}
            />

        } else {
            elem = <input
                {...props}
                value={currentValue}
                readOnly
            />
        }

        let items = this.props.withSearch
            ? this.filterItems(this.state.searchValue)
            : this.props.items;

        if (tools.empty(items)) {
            items = [{text: '', value: null}];
        }

        return <div
            ref={this.rootRef}

            {...tools.cls(
                'uiSelect',
                this.state.hasFocus && 'hasFocus',
                this.state.isOpen && 'isOpen',
                this.props.up && 'isUp',
            )}>

            {this.props.label && <div className="uiLabel">{this.props.label}</div>}

            <div className="uiSelectContainer">
            <div className="uiControlBox">
                {elem}

                {this.props.withClear && <Button
                    noTab
                    className={tools.empty(currentValue) ? 'uiInputClearButtonHidden' : 'uiInputClearButton'}
                    whenTouched={() => this.onClearClick()}/>
                }

                <Button
                    noTab
                    className="uiSelectToggleButton"
                    whenTouched={() => this.onToggleClick()}/>
            </div>

            <Menu
                value={this.props.value}
                items={items}
                whenSelected={value => this.valueSelected(value)}
            />
            </div>
        </div>
    }

    filterItems(value) {
        return this.props.items.filter(it =>
            it.text.toLowerCase().startsWith(value.toLowerCase())
        );
    }

    protected onClick(e: React.MouseEvent<any>) {
        this.setOpen(true);
    }

    protected onChange(e: React.SyntheticEvent<any>) {
        this.setState(({searchValue: e.currentTarget.value}));
        this.setOpen(true);
    }

    protected onKeyDown(e: React.KeyboardEvent<any>) {
    }

    protected gotFocus() {
        super.gotFocus();
        this.setState({searchValue: ''});
    }

    protected lostFocus() {
        super.lostFocus();
        this.setState({searchValue: '', isOpen: false});
    }

    protected onClearClick() {
        this.setState({searchValue: ''});
        if (this.props.whenChanged)
            this.props.whenChanged(null);
        // this.grabFocus();
        // this.setState({searchValue: ''});
        // this.setOpen(true);
    }

    protected onToggleClick() {
        this.grabFocus();
        this.setOpen(!this.state.isOpen);
    }

    protected grabFocus() {
        if (this.inputRef.current)
            this.inputRef.current.focus();
    }

    protected valueSelected(value) {
        this.grabFocus();
        this.setOpen(false);
        this.setState({searchValue: this.textFor(value)});
        if (this.props.whenChanged)
            this.props.whenChanged(value);
    }

    protected setOpen(v) {
        this.setState({isOpen: v});
    }

    protected textFor(value) {
        for (let p of this.props.items) {
            if (p.value === value)
                return p.text;
        }
        return '';
    }
}

export class ColorSelect extends UiComponent<ColorSelectProps, SelectState> {

    inputRef: React.RefObject<any>;
    rootRef: React.RefObject<HTMLDivElement>;

    constructor(props) {
        super(props);
        this.inputRef = React.createRef();
        this.rootRef = React.createRef();
        this.state = {isOpen: false, searchValue: ''} as SelectState;
    }

    render() {

        let props = {
            className: 'uiRawInput',
            tabIndex: 0,
            ref: this.inputRef,
            title: this.props.tooltip || '',
            placeholder: this.props.placeholder || '',
            onClick: e => this.onClick(e),
            style: {backgroundColor: this.props.value},
            ...this.focusEvents()
        };

        let elem = <input
            {...props}
            value={''}
            readOnly
        />;

        return <div
            ref={this.rootRef}

            {...tools.cls(
                'uiSelect',
                'uiColorSelect',
                this.state.hasFocus && 'hasFocus',
                this.state.isOpen && 'isOpen'
            )}>

            {this.props.label && <div className="uiLabel">{this.props.label}</div>}

            <div className="uiControlBox">
                {elem}

                {<Button
                    noTab
                    className="uiSelectToggleButton"
                    whenTouched={() => this.onToggleClick()}/>
                }
            </div>

            <ColorMenu
                value={this.props.value}
                items={this.props.items}
                whenSelected={value => this.valueSelected(value)}
            />
        </div>
    }

    protected onClick(e: React.MouseEvent<any>) {
        this.setOpen(true);
    }

    protected onKeyDown(e: React.KeyboardEvent<any>) {
    }

    protected lostFocus() {
        super.lostFocus();
        this.setOpen(false);
    }

    protected onToggleClick() {
        this.grabFocus();
        this.setOpen(!this.state.isOpen);
    }

    protected grabFocus() {
        if (this.inputRef.current)
            this.inputRef.current.focus();
    }

    protected valueSelected(value) {
        this.grabFocus();
        this.setOpen(false);
        if (this.props.whenChanged)
            this.props.whenChanged(value);
    }

    protected setOpen(v) {
        this.setState({isOpen: v});
    }

}
