import * as ol from 'openlayers';

import * as types from '../types';
import * as api from '../core/gws-api';

let uid = 0;

export class Feature implements types.IMapFeature {
    uid: string = '';
    attributes: Array<api.Attribute> = [];
    elements: types.Dict = {};
    layerUid: string = '';
    mode: types.FeatureMode;

    styleNames = {
        normal: '',
        selected: '',
        edit: '',
    };

    label: string = '';
    oFeature?: ol.Feature = null;

    map: types.IMapManager;

    constructor(map, args: types.IMapFeatureArgs) {
        this.map = map;
        this.mode = 'normal';

        if (args.props) {
            this.uid = args.props.uid;
            this.attributes = args.props.attributes || [];
            this.elements = args.props.elements || {};
            this.layerUid = args.props.layerUid || '';
        } else {
            this.uid = '_feature_' + (++uid);
        }

        this.oFeature = this.oFeatureFromArgs(args);
        if (this.oFeature) {
            this.oFeature['_gwsFeature'] = this;
        }

        if (args.style) {
            this.styleNames.normal = this.map.style.nameFor(args.style);
        } else if (args.props && args.props.style) {
            this.styleNames.normal = this.map.style.nameFor(args.props.style);
        }

        if (args.selectedStyle) {
            this.styleNames.selected = this.map.style.nameFor(args.selectedStyle);
        }

        if (args.editStyle) {
            this.styleNames.edit = this.map.style.nameFor(args.editStyle);
        }

        if (args.label) {
            this.setLabel(args.label);
        } else if (this.elements.label) {
            this.setLabel(this.elements.label);
        } else if (this.oFeature) {
            this.setLabel(this.oFeature.get('label'));
        }
    }

    get geometry() {
        return this.oFeature ? this.oFeature.getGeometry() : null;
    }

    get shape() {
        let geom = this.geometry;
        return geom ? this.map.geom2shape(geom) : null;
    }

    get props() {
        return {
            attributes: this.attributes,
            elements: this.elements,
            layerUid: this.layerUid,
            shape: this.shape,
            style: this.map.style.propsFor(this.styleNames.normal),
            uid: this.uid
        }
    }

    setMode(mode) {
        this.mode = mode;
        this.updateOlStyle();
    }

    setStyles(m) {
        this.styleNames = {...this.styleNames, ...m};
        this.updateOlStyle();
    }

    setLabel(label: string) {
        this.label = label;
        if (this.oFeature)
            this.oFeature.set('label', label);
    }

    setGeometry(geom) {
        if (this.oFeature)
            this.oFeature.setGeometry(geom);
        else
            this.oFeature = new ol.Feature(geom);
    }

    setChanged() {
        if (this.oFeature)
            this.oFeature.changed();
    }

    protected updateOlStyle() {
        if (!this.oFeature)
            return;

        let s = {
            normal: this.styleNames.normal,
            selected: this.styleNames.selected || this.styleNames.normal,
            edit: this.styleNames.edit || this.styleNames.selected || this.styleNames.normal
        };

        this.oFeature.setStyle(this.map.style.functionFor(s[this.mode]));
    }


    protected oFeatureFromArgs(args) {
        if (args.oFeature) {
            return args.oFeature;
        }

        if (args.geometry) {
            return new ol.Feature(args.geometry)
        }

        if (args.props.shape) {
            let geom = this.map.shape2geom(args.props.shape);
            return new ol.Feature(geom);
        }
    }
}