<?xml version="1.0" encoding="UTF-8"?>
<WMS_Capabilities version="1.3.0" xmlns="http://www.opengis.net/wms" xmlns:xlink="http://www.w3.org/1999/xlink"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://www.opengis.net/wms http://schemas.opengis.net/wms/1.3.0/capabilities_1_3_0.xsd">

@option filter xml

@def geographic_bounding_box(extent)
    @let e = writer.extent_to_4326(extent)
    <EX_GeographicBoundingBox>
        <westBoundLongitude>{e[0] | ':.3f'}</westBoundLongitude>
        <eastBoundLongitude>{e[1] | ':.3f'}</eastBoundLongitude>
        <southBoundLatitude>{e[2] | ':.3f'}</southBoundLatitude>
        <northBoundLatitude>{e[3] | ':.3f'}</northBoundLatitude>
    </EX_GeographicBoundingBox>
@end

@def bounding_box(extent)
    <BoundingBox
            CRS="{project.map.crs}"
            minx="{extent[0]}"
            miny="{extent[1]}"
            maxx="{extent[2]}"
            maxy="{extent[3]}"
    />
@end

@def layer_caps(node)
    <Layer queryable="{node.queryable}">
        <Name>{node.layer.uid}</Name>
        <Title>{node.layer.title}</Title>
        <Abstract>{node.layer.meta.abstract}</Abstract>
        <CRS>{project.map.crs}</CRS>

        @each node.sub as sub_node
            @layer_caps sub_node
        @end

    </Layer>
@end




    <Service>
        <Name>WMS</Name>
        <Title>{project.title}</Title>

        @with project.meta as meta
            <Abstract>{meta.abstract}</Abstract>
            <KeywordList>
                @each meta.keywords as kw
                    <Keyword>{kw}</Keyword>
                @end
            </KeywordList>
        @end

        @with project.meta.contact as co
            <ContactInformation>
                <ContactPersonPrimary>
                    <ContactPerson>{co.person}</ContactPerson>
                    <ContactOrganization>{co.organization}</ContactOrganization>
                </ContactPersonPrimary>
                <ContactPosition>{co.position}</ContactPosition>
                <ContactAddress>
                    <AddressType>postal</AddressType>
                    <Address>{co.address}</Address>
                    <City>{co.city}</City>
                    <StateOrProvince>{co.area}</StateOrProvince>
                    <PostCode>{co.zip}</PostCode>
                    <Country>{co.country}</Country>
                </ContactAddress>
                <ContactVoiceTelephone>{co.phone}</ContactVoiceTelephone>
                <ContactElectronicMailAddress>{co.email}</ContactElectronicMailAddress>
            </ContactInformation>
        @end

    </Service>

    <Capability>
        <Request>
            <GetCapabilities>
                <Format>text/xml</Format>
                <DCPType>
                    <HTTP>
                        <Get>
                            <OnlineResource xmlns:xlink="http://www.w3.org/1999/xlink" xlink:type="simple"
                                            xlink:href="{service_endpoint}"/>
                        </Get>
                    </HTTP>
                </DCPType>
            </GetCapabilities>
            <GetMap>
                <Format>image/png</Format>
                <DCPType>
                    <HTTP>
                        <Get>
                            <OnlineResource xmlns:xlink="http://www.w3.org/1999/xlink" xlink:type="simple"
                                            xlink:href="{service_endpoint}"/>
                        </Get>
                    </HTTP>
                </DCPType>
            </GetMap>
            <GetFeatureInfo>
                <Format>application/vnd.ogc.gml</Format>
                <DCPType>
                    <HTTP>
                        <Get>
                            <OnlineResource xmlns:xlink="http://www.w3.org/1999/xlink" xlink:type="simple"
                                            xlink:href="{service_endpoint}"/>
                        </Get>
                    </HTTP>
                </DCPType>
            </GetFeatureInfo>
        </Request>
        <Exception>
            <Format>XML</Format>
        </Exception>

        <Layer>
            <Name>{project.uid}</Name>
            <Title>{project.title}</Title>
            <CRS>{project.map.crs}</CRS>

            @geographic_bounding_box(project.map.extent)
            @bounding_box(project.map.extent)

            @each writer.project_layer_tree() as node
                @layer_caps node
            @end
        </Layer>

    </Capability>
</WMS_Capabilities>